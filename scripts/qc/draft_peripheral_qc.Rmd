---
title: "Figure drafts for Jan 2017 submission"
author: "Eric Kernfeld"
date: "January 18, 2017"
output: html_document
---

```{r}
results_path = Sys.getenv( "FREEZR_DESTINATION" )

dge_10_11 = c( "time_sorted_10", "time_sorted_11" ) %>% 
  get_sample_groups( combine = T ) %>% 
  load_thymus_profiling_data %>% 
  dge_merge_list %>% 
  seuratify_thy_data( results_path )

dge_10_11 = add_maehrlab_metadata( dge_10_11, "eday" )

replicate_markers = aggregate.nice(t(dge_10_11@data), by = dge_10_11@ident, mean)
replicate_markers = t(replicate_markers)
replicate_markers = as.data.frame(replicate_markers)
replicate_markers$rep3_minus_rep4 = replicate_markers$e11_5rep3 - replicate_markers$e11_5rep4
replicate_markers$e10_5 = NULL
replicate_markers$e10_5rep3 = NULL
replicate_markers = replicate_markers[order(replicate_markers$rep3_minus_rep4), ]
flip_table = function(df) df[nrow(df):1, ]
replicate_markers %>% subset( rep3_minus_rep4 > 0 ) %>% flip_table %>%
  write.table( file.path( results_path, "rep3_hi_rep4_lo.txt"), quote = F, row.names = T, sep = "\t" )
replicate_markers %>% subset( rep3_minus_rep4 < 0 ) %>% 
  write.table( file.path( results_path, "rep3_lo_rep4_hi.txt"), quote = F, row.names = T, sep = "\t" )

p = FetchData( dge_10_11, c("nUMI", "orig.ident", "eday") ) %>%
  subset( eday == 11.5) %>% ggplot() + 
  geom_density( aes( x = nUMI, fill = orig.ident ), alpha = 0.4 )
ggsave( file.path( results_path, "nUMI_by_rep_11.pdf" ), p)

p = FetchData( dge_10_11, c("nUMI", "orig.ident", "eday") ) %>%
  subset( eday == 10.5) %>% ggplot() + 
  geom_density( aes( x = nUMI, fill = orig.ident ), alpha = 0.4 )
ggsave( file.path( results_path, "nUMI_by_rep_10.pdf" ), p)

all_params = expand.grid( cc_method = c( "average" ),
                          excess_var_cutoff = c( 0.5 ),
                          log_expr_cutoff = c( 0.1 ), 
                          prop_genes_to_select = NA, 
                          num_genes_to_select = NA, 
                          var_gene_method = "seurat",
                          num_pc = c( 8 ), 
                          clust_method = "SNN",
                          clust_granularities_as_string = "0.5",
                          plot_all_var_genes = F,
                          stringsAsFactors = F )
dge_10_11 = explore_embeddings( dge_10_11, results_path = results_path, all_params )

faceted_tsne( dge_10_11, results_path )


p = VlnPlot( dge_10_11, "Il7", group.by = "orig.ident", do.ret = T)
ggsave( file.path( results_path, "Il7_vln.pdf"), p[[1]] )

il7_summary = dge_10_11 %>% FetchData( c( "Il7", "orig.ident" ) ) %>% mutate( Il7 = Il7>0 ) %>% table 
rownames( il7_summary ) = c( "Il7-", "Il7+")
write.table( il7_summary, file = file.path( results_path, "Il7.txt" ), sep = "\t", quote = F )

```
