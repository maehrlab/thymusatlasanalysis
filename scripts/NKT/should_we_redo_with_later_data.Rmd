---
title: "Figure drafts for Jan 2017 submission"
author: "Eric Kernfeld"
date: "January 18, 2017"
output: html_document
---

```{r}

results_path = Sys.getenv( "FREEZR_DESTINATION" )

dge_atlas = inventory_get( "overview_clean_labeled" ) %>% readRDS
dge_late = inventory_get( "explore_17_18_p0" ) %>% readRDS
dge_late = knn_classifier( dge_train = dge_atlas, dge_test = dge_late )

dge_nkt_12_p0 = SeuratMerge( SubsetDataFlex(dge_atlas, "ident", "ident=='BLD5'"), 
                             SubsetDataFlex(dge_late , "ident", "ident==3"), 
                             preserve_ident = F )

dge_nkt_12_p0 %<>% add_maehrlab_metadata("eday")
dge_nkt_12_p0@data.info$eday %<>% (function(x) ifelse(is.na(x), 19.5, x)) %>% as.numeric
FetchData( dge_nkt_12_p0, "eday" ) %>% table
dge_nkt_12_p0 %<>% add_tcr()

all_params = expand.grid( cc_method = c( "average" ),
                          excess_var_cutoff = c( 0.5 ),
                          log_expr_cutoff = c( 0.10 ), 
                          num_genes_to_select = NA, 
                          prop_genes_to_select = NA, 
                          var_gene_method = "seurat",
                          num_pc = c( 25 ), 
                          clust_method = "SNN",
                          clust_granularities_as_string = "0.5",
                          plot_all_var_genes = F,
                          stringsAsFactors = F )

dge_nkt_12_p0 %<>% explore_embeddings( results_path, all_params)
dge_nkt_12_p0 %>% FetchData(c("tSNE_1", "tSNE_2")) -> tsne_temp
dge_nkt_12_p0@data.info$tSNE_1 = NULL
dge_nkt_12_p0@data.info$tSNE_2 = NULL
dge_nkt_12_p0 = ProjectCells(dge_test = dge_nkt_12_p0, 
                             dge_train = inventory_get("dge_ftoc_nkt") %>% readRDS,
                             to_project = c("tSNE_1", "tSNE_2") )
dge_nkt_12_p0 = knn_classifier(dge_train = inventory_get("dge_ftoc_nkt") %>% readRDS, 
                               dge_test = dge_nkt_12_p0, ident.use = "major_celltype")

save_feature_plots( dge_nkt_12_p0, results_path, gene_list = "eday", cols.use = extended_eday_colors)
custom_feature_plot( dge_nkt_12_p0, "ident" )
save_feature_plots( dge_nkt_12_p0, results_path, gene_list = "classifier_ident", cols.use = NKT_LTI_COLS)

custom_feature_plot( dge_nkt_12_p0, "classifier_badness" )
custom_feature_plot( dge_nkt_12_p0, "Rorc" )
custom_feature_plot( dge_nkt_12_p0, "Tnfsf11" )
custom_feature_plot( dge_nkt_12_p0, "Ltb" )
custom_feature_plot( dge_nkt_12_p0, "Cd27" )
save_feature_plots( dge_nkt_12_p0, results_path, gene_list = get_LTi_genes() )
save_feature_plots( dge_nkt_12_p0, results_path, gene_list = c("Cd3e", "Cd3g", "Cd3d") )
save_feature_plots( dge_nkt_12_p0, results_path, gene_list = c("Id2", "Tox", "Il23r") )
custom_feature_plot( dge_nkt_12_p0, "TRA_TOTAL" )
custom_feature_plot( dge_nkt_12_p0, "TRB_TOTAL" )
custom_feature_plot( dge_nkt_12_p0, "TRD_TOTAL" )
custom_feature_plot( dge_nkt_12_p0, "TRG_TOTAL", use_rank = T )


```
